name: Mobile-Ios

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  Build-iOS:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@main
        with:
          fetch-depth: 0

      - name: Determine Version
        id: ver
        run: |
          if git describe --tags --exact-match >/dev/null 2>&1; then
            echo "version=$(git describe --tags --exact-match)" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
          fi

      - uses: krdlab/setup-haxe@master
        with:
          haxe-version: 4.3.6

      - name: Install Haxelib Dependencies
        run: |
          haxelib install hxcpp
          haxelib install thx.core
          haxelib install thx.semver
          haxelib install lime
          haxelib install openfl
          haxelib install flixel
          haxelib install flixel-ui
          haxelib install flixel-addons
          haxelib install flxanimate
          haxelib install json2object
          haxelib git polymod https://github.com/PabloelproxD210/Polymod.git
          haxelib git hscript https://github.com/T5mpler/hscript-dnb
          haxelib install hxvlc
          haxelib git discord_rpc https://github.com/Aidan63/linc_discord-rpc
          haxelib install hmm
          haxelib run hmm install

      - name: Fix thx.core crash on iOS
        run: |
          haxelib remove thx.error || true
          haxelib remove thx.languages || true

      # --------------------------------------------------
      # Build Haxe code FIRST (generates hxcpp C++ files)
      # --------------------------------------------------
      - name: Build iOS (nosign) - Generate C++ code
        run: haxelib run lime build ios -nosign -D officialBuild -DMOBILE_BUILD -D HXCPP_CPP11 || true

      # --------------------------------------------------
      # Patch thx.Nil clash AFTER C++ is generated
      # --------------------------------------------------
      - name: Patch thx.Nil for iOS ObjC Macro Clash
        shell: bash
        run: |
          echo "=== Running universal thx.Nil patcher ==="

          cat > fix_thx_nil_all_targets.py << 'EOF'
          import os

          PATCH_LINES = [
              "#ifdef Nil",
              "#undef Nil",
              "#endif",
              ""
          ]

          def patch_file(path):
              try:
                  text = open(path, "r", errors="ignore").read()
                  if "#undef Nil" in text:
            print("[SKIP] Already patched:", path)
            return
                  with open(path, "w", errors="ignore") as f:
            f.write("\n".join(PATCH_LINES) + text)
                  print("[PATCHED]", path)
              except Exception as e:
                  print("[ERROR]", path, e)

          print("=== AUTO-DETECTING ALL thx FOLDERS ===")

          patch_count = 0
          thx_dirs = []

          for root, dirs, files in os.walk(".", topdown=True):
              for d in dirs:
                  if d == "thx":
            full = os.path.join(root, d)
            thx_dirs.append(full)

          print("\nDetected thx directories:")
          for t in thx_dirs:
              print("  -", t)

          print("\nPatching...\n")

          for folder in thx_dirs:
              for root, dirs, files in os.walk(folder):
                  for f in files:
                      if f.endswith((".h", ".hpp", ".cpp", ".mm")):
                patch_file(os.path.join(root, f))
                patch_count += 1

          print("\n=== Done. Patched", patch_count, "files across ALL platforms ===")
          EOF

          python3 fix_thx_nil_all_targets.py || true

      # --------------------------------------------------
      # Package IPA
      # --------------------------------------------------
      - name: Package IPA
        run: |
          cd export/release/ios/build/*-iphoneos
          mkdir Payload
          mv *.app Payload/
          zip -r ~/ios-${{ steps.ver.outputs.version }}.ipa Payload

      - uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ~/ios-*.ipa
